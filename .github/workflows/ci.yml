name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Prevent multiple workflows from running simultaneously
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-test:
    name: Lint, Type Check & Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      issues: write
      pull-requests: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true  # Don't fail build, but warn about vulnerabilities
      
      - name: Run linter
        run: npm run lint 2>&1 | tee lint-output.txt || true
        continue-on-error: true  # Continue if linting fails (can be changed to false once linting is clean)
        id: lint
  
      - name: Create/Update linting errors issue
        if: github.event_name == 'pull_request' || github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Read linting output
            let lintOutput = '';
            try {
              if (fs.existsSync('lint-output.txt')) {
                lintOutput = fs.readFileSync('lint-output.txt', 'utf-8');
              }
            } catch (error) {
              lintOutput = 'Could not read linting output';
            }
            
            // Check if there are actual linting errors (not just warnings)
            const hasErrors = lintOutput.includes('Error:') || lintOutput.includes('‚úñ');
            
            if (!hasErrors && lintOutput.includes('No ESLint warnings')) {
              // No errors, close any existing issue
              const issueTitle = 'üîç ESLint Errors - Automated CI Report';
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'linting,ci,automated',
                per_page: 100
              });
              
              const existingIssue = issues.data.find(issue => issue.title === issueTitle);
              if (existingIssue) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  state: 'closed'
                });
                console.log(`Closed issue #${existingIssue.number} - no linting errors`);
              }
              return;
            }
            
            if (!hasErrors) {
              console.log('No linting errors found, skipping issue creation');
              return;
            }
            
            // Prepare issue details
            const issueTitle = 'üîç ESLint Errors - Automated CI Report';
            const issueLabels = ['linting', 'ci', 'automated'];
            const branchName = context.payload.pull_request?.head?.ref || context.ref.replace('refs/heads/', '');
            const prNumber = context.payload.pull_request?.number;
            const prLink = prNumber ? `#${prNumber}` : 'N/A';
            
            const issueBody = `## ESLint Errors Report
            
            This issue was automatically created by the CI pipeline due to linting errors.
            
            **Branch:** \`${branchName}\`
            **PR:** ${prLink}
            **Commit:** ${context.sha.substring(0, 7)}
            **Workflow Run:** [View Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            <details>
            <summary>Click to expand linting errors</summary>
            
            \`\`\`
            ${lintOutput.substring(0, 60000)}  // GitHub has a 65KB limit for issue body
            \`\`\`
            
            </details>
            
            ---
            *This issue will be automatically updated on each CI run with linting errors.*
            *To fix: Run \`npm run lint\` locally and fix the errors.*
            `;
            
            // Search for existing issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: issueLabels.join(','),
              per_page: 100
            });
            
            const existingIssue = issues.data.find(issue => issue.title === issueTitle);
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: issueLabels
              });
              console.log(`Created new issue #${issue.data.number}`);
            }
      
      - name: Type check
        run: npx tsc --noEmit
        continue-on-error: true  # Continue if type checking fails (can be changed to false once types are fixed)
      
      - name: Run tests with coverage
        run: npm run test:coverage
        continue-on-error: true  # Continue if tests fail (can be changed to false once tests are fixed)
      
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30
      
      # Upload coverage to Codecov (free for public repos, optional token)
      - name: Upload coverage to Codecov
        if: github.event_name == 'pull_request'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true  # Don't fail if Codecov isn't configured
      
      # Optional: Comment coverage on PRs
      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          lcov-file: ./coverage/lcov.info
          delete-old-comments: true
  
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: lint-and-test
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-
      
      - name: Build application
        run: npm run build
        env:
          # Minimal env vars for build (use dummy values if secrets not set)
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        # Note: If secrets are not set, Next.js build may fail
        # Set these in GitHub Settings ‚Üí Secrets ‚Üí Actions for production builds
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: .next/
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Analyze bundle size
        run: |
          echo "## Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          if [ -d ".next/static/chunks" ]; then
            TOTAL_SIZE=$(du -sh .next/static/chunks | cut -f1)
            echo "Total bundle size: $TOTAL_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "Total bundle size: $TOTAL_SIZE"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Largest JavaScript Chunks" >> $GITHUB_STEP_SUMMARY
            echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|" >> $GITHUB_STEP_SUMMARY
            find .next/static/chunks -type f -name "*.js" -exec ls -lh {} \; | sort -k5 -hr | head -5 | awk '{print "| " $9 " | " $5 " |"}' >> $GITHUB_STEP_SUMMARY
          else
            echo "Build artifacts not found for bundle analysis" >> $GITHUB_STEP_SUMMARY
          fi
  
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .next/
      
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3000
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: ./.lighthouserc.json
        continue-on-error: true  # Don't fail build on Lighthouse issues
        env:
          # Lighthouse CI will start the server automatically via .lighthouserc.json
          # Environment variables needed for Next.js server
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://dummy.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'dummy-key' }}
          # Optional: GitHub App token for PR integration
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
  
  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-extended,security-and-quality
      
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
  
  secrets-scan:
    name: Secrets Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better scanning
      
      - name: GitGuardian Secrets Scan
        uses: GitGuardian/ggshield-action@master
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
        continue-on-error: true  # Don't fail if GitGuardian isn't configured
        # Note: If using GitHub App integration, API key is optional
        # The GitHub App will automatically scan on PRs
        # To enable: Install GitGuardian GitHub App from https://github.com/apps/gitguardian

